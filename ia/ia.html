<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev.IA</title>
    <!-- CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link rel="stylesheet" href="../estilos/ia.css">
    <link rel="stylesheet" href="../estilos/style.css">
    <link rel="stylesheet" href="../estilos/media-query.css">
    <link rel="stylesheet" href="../animation/animation.css">
</head>
<body>
    <div class="chatbot">
        <header>
            <div class="title-wrapper">
                <div id="typing-text"></div>
                <span id="blinking-cursor">_</span>
            </div>
            <i id="burguer" class="material-icons" onclick="clickMenu()">menu</i>
            <nav>
                <menu id="itens">
                    <ul class="menu">
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="../news/news.html">News</a></li>
                        <li><a href="../games/games.html">Games</a></li>
                        <li><a href="#">IA</a></li>
                        <li><a href="../chat/chat.html">Chat</a></li>
                        <li><a href="../login-cadastro/login-cadastro.html">Login | Cadastro</a></li>
                    </ul>
                </menu>
            </nav>
        </header>
        
        <main>
            <ul class="chatbox">
                <li class="chat incoming">
                    <span class="material-icons">smart_toy</span>
                    <p>Hi there <br>How can I help you today?</p>
                </li>
            </ul>
            <div class="chat-input">
                <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
                <span><button id="send-btn" class="material-symbols-rounded">send</button></span>
            </div>
        </main>
        
        <footer>
            <p>Criado por <a href="https://github.com/DevSpector" title="Spector" target="_blank">Eliel Andre de Queiroz.</a></p>
        </footer>
    </div>

    <script src="../script/script.js"></script>
    <script>
        const text = "Dev.IA";
        const typingText = document.getElementById("typing-text");
        const cursor = document.getElementById("blinking-cursor");

        let i = 0;

        function typeWriter() {
            if (i < text.length) {
                typingText.textContent += text.charAt(i);
                i++;
                setTimeout(typeWriter, 150);
            } else {
                cursor.style.opacity = "1";
            }
        }

        setTimeout(typeWriter, 500);
    </script>
    <script>
        const chatbox = document.querySelector(".chatbox");
        const chatInput = document.querySelector(".chat-input textarea");
        const sendChatBtn = document.querySelector("#send-btn");
        let userMessage = null;
        const inputInitHeight = chatInput.scrollHeight;

        const API_KEY = "AIzaSyACm1vgMXA8CR5b92o79W-bUoEMjQi4Aa4"; // Replace with your actual API key
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        const createChatLi = (message, className) => {
            const chatLi = document.createElement("li");
            chatLi.classList.add("chat", `${className}`);
            let chatContent = className === "outgoing" 
                ? `<p></p>` 
                : `<span class="material-icons">smart_toy</span><p></p>`;
            chatLi.innerHTML = chatContent;
            chatLi.querySelector("p").textContent = message;
            return chatLi;
        }

        const generateResponse = async (chatElement) => {
            const messageElement = chatElement.querySelector("p");
            
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ 
                            role: "user", 
                            parts: [{ text: userMessage }] 
                        }] 
                    }),
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                
                // More robust response handling
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    messageElement.textContent = data.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '$1');
                } else {
                    throw new Error("Unexpected API response structure");
                }
            } catch (error) {
                console.error("Error:", error);
                messageElement.classList.add("error");
                messageElement.textContent = "Oops! Something went wrong. Please try again.";
            } finally {
                chatbox.scrollTo(0, chatbox.scrollHeight);
            }
        }

        const handleChat = () => {
            userMessage = chatInput.value.trim();
            if (!userMessage) return;

            chatInput.value = "";
            chatInput.style.height = `${inputInitHeight}px`;
            
            chatbox.appendChild(createChatLi(userMessage, "outgoing"));
            chatbox.scrollTo(0, chatbox.scrollHeight);
            
            setTimeout(() => {
                const incomingChatLi = createChatLi("Thinking...", "incoming");
                chatbox.appendChild(incomingChatLi);
                chatbox.scrollTo(0, chatbox.scrollHeight);
                generateResponse(incomingChatLi);
            }, 600);
        }

        chatInput.addEventListener("input", () => {
            chatInput.style.height = `${inputInitHeight}px`;
            chatInput.style.height = `${chatInput.scrollHeight}px`;
        });

        chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) {
                e.preventDefault();
                handleChat();
            }
        });

        sendChatBtn.addEventListener("click", handleChat);
    </script>
</body>
</html>